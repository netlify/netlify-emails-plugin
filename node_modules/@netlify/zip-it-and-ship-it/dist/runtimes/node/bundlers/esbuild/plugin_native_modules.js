"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getNativeModulesPlugin = void 0;
const path_1 = __importDefault(require("path"));
const read_package_json_fast_1 = __importDefault(require("read-package-json-fast"));
const detect_native_module_js_1 = require("../../utils/detect_native_module.js");
// Filters out relative or absolute file paths.
const packageFilter = /^([^./]*)$/;
// Filters valid package names and extracts the base directory.
const packageName = /^([^@][^/]*|@[^/]*\/[^/]+)(?:\/|$)/;
const findNativeModule = (packageJsonPath, cache) => {
    if (cache[packageJsonPath] === undefined) {
        // eslint-disable-next-line no-param-reassign, promise/prefer-await-to-then
        cache[packageJsonPath] = (0, read_package_json_fast_1.default)(packageJsonPath).then((data) => [Boolean((0, detect_native_module_js_1.isNativeModule)(data)), data], () => [undefined, {}]);
    }
    return cache[packageJsonPath];
};
const getNativeModulesPlugin = (externalizedModules) => ({
    name: 'external-native-modules',
    setup(build) {
        const cache = {};
        // eslint-disable-next-line max-statements
        build.onResolve({ filter: packageFilter }, async (args) => {
            const pkg = packageName.exec(args.path);
            if (!pkg)
                return;
            let directory = args.resolveDir;
            while (true) {
                if (path_1.default.basename(directory) !== 'node_modules') {
                    const modulePath = path_1.default.join(directory, 'node_modules', pkg[1]);
                    const packageJsonPath = path_1.default.join(modulePath, 'package.json');
                    const [isNative, packageJsonData] = await findNativeModule(packageJsonPath, cache);
                    // eslint-disable-next-line max-depth
                    if (isNative === true) {
                        // eslint-disable-next-line max-depth
                        if (externalizedModules[args.path] === undefined) {
                            // eslint-disable-next-line no-param-reassign
                            externalizedModules[args.path] = {};
                        }
                        // eslint-disable-next-line no-param-reassign
                        externalizedModules[args.path][modulePath] = packageJsonData.version;
                        return { path: args.path, external: true };
                    }
                    // eslint-disable-next-line max-depth
                    if (isNative === false) {
                        return;
                    }
                }
                const parentDirectory = path_1.default.dirname(directory);
                if (parentDirectory === directory) {
                    break;
                }
                directory = parentDirectory;
            }
        });
    },
});
exports.getNativeModulesPlugin = getNativeModulesPlugin;
//# sourceMappingURL=plugin_native_modules.js.map